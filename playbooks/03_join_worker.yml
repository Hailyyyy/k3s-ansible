---
- name: Join wk2 to k3s cluster (install k3s-agent)
  hosts: k3s_worker_new
  become: true
  gather_facts: false

  tasks:
    - name: Ensure curl is installed (wk2)
      ansible.builtin.apt:
        name: curl
        state: present
        update_cache: true

    - name: Install k3s agent if missing
      ansible.builtin.shell: |
        set -euo pipefail

        if systemctl is-active --quiet k3s-agent; then
          echo "k3s-agent already active. skip."
          exit 0
        fi

        export K3S_URL="{{ k3s_url }}"
        export K3S_TOKEN="{{ k3s_token }}"
        curl -sfL https://get.k3s.io | sh -s - agent
      args:
        executable: /bin/bash

